#!/bin/sh

set -e
set -u

ostype=$(uname  | tr '[:upper:]' '[:lower:]')
if [ -z "$BOSH_PACKAGES_DIR" ]; then
    pkg_dir=$(readlink -nf /var/vcap/packages/golang-1.12-${ostype})
else
  pkg_dir=$BOSH_PACKAGES_DIR/golang-1.12-${ostype}
fi

PACKAGE_NAME="github.com/orange-cloudfoundry/boshupdate_exporter"

source ${pkg_dir}/bosh/compile.env

mkdir -p ${GOPATH}/src/${PACKAGE_NAME}
mkdir -p ${BOSH_INSTALL_TARGET}/bin
cp -r boshupdate_exporter/* ${GOPATH}/src/${PACKAGE_NAME}

cd ${GOPATH}/src/${PACKAGE_NAME}/exporter
go build -a -ldflags "-s -w" -gcflags="all=-trimpath=$GOPATH" -o ${BOSH_INSTALL_TARGET}/bin/boshupdate_exporter
